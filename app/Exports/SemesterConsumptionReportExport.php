<?php

namespace App\Exports;

use Maatwebsite\Excel\Concerns\FromCollection;
use App\models\raisoni\ConsumptionReport;
use Maatwebsite\Excel\Concerns\WithHeadings;
use Maatwebsite\Excel\Concerns\Exportable;
use Maatwebsite\Excel\Concerns\WithEvents;
use Maatwebsite\Excel\Events\AfterSheet;
use Maatwebsite\Excel\Concerns\ShouldAutoSize;
use Maatwebsite\Excel\Concerns\WithCustomStartCell;
use App\models\raisoni\SemesterMaster;
use DB;

class SemesterConsumptionReportExport implements FromCollection, WithCustomStartCell , WithHeadings,WithEvents, ShouldAutoSize

{
    protected $semester; 

    function __construct($semester) {
        $this->semester = $semester;
    }
    /**
    * @return \Illuminate\Support\Collection
    */
    public function collection()
    {
        
        $where_str    = "1 = ?";
        $where_params = array(1);   
        DB::statement(DB::raw('set @rownum=0'));   
        $columns = [DB::raw('@rownum  := @rownum  + 1 AS rownum'),'examination','programme','department','department as Department'];

        if (!empty($this->semester)) {
            $semester = $this->semester;
            $where_str .= " AND (term = '$semester')";
        }

        $SemesterConsumptionReportExport = ConsumptionReport::select($columns)
        		->groupBy('examination','programme','department')
                 ->whereRaw($where_str, $where_params)
                 ->orderBy('examination','asc')
                 ->get()->toArray();

        foreach ($SemesterConsumptionReportExport as $key => $value) {


        	$SemesterConsumptionReportCount = ConsumptionReport::select('id')
                 ->where('examination',$value['examination'])
                 ->where('programme',$value['programme'])
                 ->where('department',$value['department'])
                 ->count();
            $SemesterConsumptionReportExport[$key]['Department'] = $SemesterConsumptionReportCount;
        }
     	return collect($SemesterConsumptionReportExport);

    }

    public function startCell(): string
    {
        return 'A3';
    }
    
    public function headings(): array{
        $row = ['Sr. No.','Exam Name','Degree','Branch','Total Count'];
        return $row;
    }

    public function registerEvents(): array
    {
        $user_data = \auth::guard('admin')->user()->username;
        
        
        return [
            AfterSheet::class    => function(AfterSheet $event) use ($user_data ){
                $event->sheet->SetCellValue('A1', "Report Generated By : ".$user_data);
                $event->sheet->mergeCells('A1:C1');
                $event->sheet->SetCellValue('D1', "Term : ".$this->semester);
                $cellRange = 'A1:D1'; 
                $event->sheet->getDelegate()->getStyle($cellRange)->getFont()->setBold(true);
                $cellRange = 'A3:g3'; // All headers
                $event->sheet->getDelegate()->getStyle($cellRange)->getFont()->setBold(true);
            },
        ];
    }
}
